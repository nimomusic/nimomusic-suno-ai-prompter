<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIMO MUSIC - Gemini AI Engine</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
        .btn-active { background: #2563eb !important; color: white !important; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- [보안 및 데이터 유틸리티] ---
        const encryptKey = (key) => btoa(key).split('').reverse().join('');
        const decryptKey = (enc) => atob(enc.split('').reverse().join(''));

        const SunoPromptGenerator = () => {
            const [language, setLanguage] = useState('ko');
            const [isGenerating, setIsGenerating] = useState(false);
            const [result, setResult] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [testStatus, setTestStatus] = useState('idle');
            
            const [formData, setFormData] = useState({
                genre: [], mood: [], vocal: [], instruments: [], mixing: [], era: '', theme: '', lyricsLanguage: 'ko'
            });

            // 원본 옵션 데이터
            const options = {
                genres: {
                    ko: ['어쿠스틱 발라드', '팝', '록', '일렉트로닉', '힙합', 'R&B', '재즈', '클래식', '포크', '인디', '컨트리', '블루스', '레게', '메탈', '펑크', '디스코', '소울', 'EDM', '하우스', '테크노', '트랜스', '덥스텝', '드럼 앤 베이스', '트랩', '보사노바', '플라멩코', '탱고', 'K-POP', 'J-POP', '시티팝', '신스팝', '뉴에이지', '앰비언트', '칠아웃', '로파이', '포스트록', '슈게이징', '인더스트리얼', '고스', '이모', '그런지', '펑크록', '하드록', '프로그레시브록'],
                    en: ['Acoustic Ballad', 'Pop', 'Rock', 'Electronic', 'Hip-Hop', 'R&B', 'Jazz', 'Classical', 'Folk', 'Indie', 'Country', 'Blues', 'Reggae', 'Metal', 'Punk', 'Disco', 'Soul', 'EDM', 'House', 'Techno', 'Trance', 'Dubstep', 'Drum and Bass', 'Trap', 'Bossa Nova', 'Flamenco', 'Tango', 'K-POP', 'J-POP', 'City Pop', 'Synth-pop', 'New Age', 'Ambient', 'Chillout', 'Lo-fi', 'Post-rock', 'Shoegaze', 'Industrial', 'Goth', 'Emo', 'Grunge', 'Punk Rock', 'Hard Rock', 'Progressive Rock']
                },
                moods: {
                    ko: ['감성적인', '경쾌한', '우울한', '에너제틱', '로맨틱', '평화로운', '긴장감 있는', '희망적인', '신비로운', '강렬한', '따뜻한', '차가운', '몽환적인', '어두운', '밝은', '슬픈', '화난', '섹시한', '유쾌한', '멜랑콜리한', '향수를 자극하는', '웅장한', '섬세한', '거친', '부드러운', '극적인', '서정적인', '애절한', '장난스러운', '진지한', '반항적인', '고요한', '격정적인', '황홀한'],
                    en: ['Emotional', 'Upbeat', 'Melancholic', 'Energetic', 'Romantic', 'Peaceful', 'Tense', 'Hopeful', 'Mysterious', 'Intense', 'Warm', 'Cold', 'Dreamy', 'Dark', 'Bright', 'Sad', 'Angry', 'Sexy', 'Cheerful', 'Melancholy', 'Nostalgic', 'Epic', 'Delicate', 'Rough', 'Smooth', 'Dramatic', 'Lyrical', 'Heartbreaking', 'Playful', 'Serious', 'Rebellious', 'Serene', 'Passionate', 'Euphoric']
                },
                vocals: {
                    ko: ['남성 보컬', '여성 보컬', '남성 듀엣', '여성 듀엣', '남녀 듀엣', '혼성 합창', '남성 합창', '여성 합창', '어린이 합창', '아카펠라', '랩', '스포큰 워드', '보컬 없음', '허밍', '휘슬링', '비브라토', '팔세토', '하모니', '백그라운드 보컬'],
                    en: ['Male Vocal', 'Female Vocal', 'Male Duet', 'Female Duet', 'Mixed Duet', 'Mixed Choir', 'Male Choir', 'Female Choir', 'Children Choir', 'A Cappella', 'Rap', 'Spoken Word', 'No Vocal', 'Humming', 'Whistling', 'Vibrato', 'Falsetto', 'Harmony', 'Background Vocal']
                },
                instruments: {
                    ko: ['어쿠스틱 기타', '일렉트릭 기타', '베이스 기타', '피아노', '신시사이저', '드럼', '일렉트로닉 드럼', '첼로', '바이올린', '비올라', '더블베이스', '하프', '플루트', '색소폰', '트럼펫', '트롬본', '클라리넷', '하모니카', '아코디언', '밴조', '만돌린', '우쿨렐레', '타블라', '봉고', '콩가', '마림바', '오르간', '스트링 섹션', '브라스 섹션', '퍼커션', '808 베이스', '샘플링', '루프', '패드 사운드'],
                    en: ['acoustic guitar', 'electric guitar', 'bass guitar', 'piano', 'synthesizer', 'drums', 'electronic drums', 'cello', 'violin', 'viola', 'double bass', 'harp', 'flute', 'saxophone', 'trumpet', 'trombone', 'clarinet', 'harmonica', 'accordion', 'banjo', 'mandolin', 'ukulele', 'tabla', 'bongo', 'conga', 'marimba', 'organ', 'string section', 'brass section', 'percussion', '808 bass', 'sampling', 'loops', 'pad sounds']
                },
                mixingStyles: {
                    ko: ['인티메이트', '시네마틱', '하이파이', '로파이', '빈티지', '모던', '로우', '폴리시', '미니멀리스트', '레이어드', '앰비언트', '컴프레스드', '리버브 헤비', '드라이', '스테레오 와이드', '모노', '애널로그', '디지털', '글리치', '디스토션', '클린', '크런치', '페이저', '코러스', '딜레이', '에코', 'A/B 스테레오', '프로덕션', '실험적', '메인스트림'],
                    en: ['intimate', 'cinematic', 'high-fidelity', 'lo-fi', 'vintage', 'modern', 'raw', 'polished', 'minimalist', 'layered', 'ambient', 'compressed', 'reverb heavy', 'dry', 'stereo wide', 'mono', 'analog', 'digital', 'glitch', 'distortion', 'clean', 'crunch', 'phaser', 'chorus', 'delay', 'echo', 'A/B stereo', 'production', 'experimental', 'mainstream']
                },
                eras: {
                    ko: ['중세', '르네상스', '바로크', '고전주의', '낭만주의', '1950s', '1960s', '1970s', '1980s', '1990s', '2000s', '2010s', '2020s', '미래적', '시대 무관'],
                    en: ['Medieval', 'Renaissance', 'Baroque', 'Classical', 'Romantic', '1950s', '1960s', '1970s', '1980s', '1990s', '2000s', '2010s', '2020s', 'Futuristic', 'Timeless']
                }
            };

            useEffect(() => {
                const saved = localStorage.getItem('_nimo_gemini_key');
                if (saved) setApiKey(decryptKey(saved));
            }, []);

            // --- [연결 테스트 & 저장] ---
            const saveAndTestKey = async () => {
                setTestStatus('testing');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "hi" }] }] })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    localStorage.setItem('_nimo_gemini_key', encryptKey(apiKey));
                    setTestStatus('success');
                    setTimeout(() => setShowSettings(false), 1000);
                } catch (e) {
                    setTestStatus('fail');
                    console.error(e);
                }
            };

            const toggleSelection = (field, value) => {
                setFormData(prev => ({
                    ...prev, [field]: prev[field].includes(value) ? prev[field].filter(v => v !== value) : [...prev[field], value]
                }));
            };

            // --- [실제 Gemini 2.5 Flash 호출] ---
            const generatePrompt = async () => {
                const savedKey = localStorage.getItem('_nimo_gemini_key');
                if (!savedKey) { setShowSettings(true); return; }
                if (formData.genre.length === 0 || !formData.theme) { alert("장르와 주제를 입력해주세요."); return; }

                setIsGenerating(true);
                const realKey = decryptKey(savedKey);

                const promptText = `You are a professional Suno AI music prompt engineer. Create a song for Suno AI v4.
                User Selection:
                - Genres: ${formData.genre.join(', ')}
                - Moods: ${formData.mood.join(', ')}
                - Vocals: ${formData.vocal.join(', ')}
                - Instruments: ${formData.instruments.join(', ')}
                - Mixing: ${formData.mixing.join(', ')}
                - Era: ${formData.era}
                - Story/Theme: ${formData.theme}
                - Lyrics Language: ${formData.lyricsLanguage === 'ko' ? 'Korean' : 'English'}

                Output:
                [Title] (A creative song title)
                [Style] (Concise comma-separated style tags for Suno)
                [Lyrics] (Full lyrics with [Intro], [Verse], [Chorus], [Bridge], [Outro] markers in ${formData.lyricsLanguage === 'ko' ? 'Korean' : 'English'})`;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${realKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    setResult(data.candidates[0].content.parts[0].text);
                } catch (err) {
                    alert("API 호출 실패! 키가 유효한지 확인하세요.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const RenderOptions = ({ label, field, list }) => (
                <div className="mb-8">
                    <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 italic">{label}</label>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 p-3 bg-white border border-gray-100 rounded-2xl max-h-40 overflow-y-auto custom-scrollbar shadow-inner">
                        {list.map(val => (
                            <button key={val} onClick={() => toggleSelection(field, val)}
                                className={`px-3 py-2 rounded-xl text-[11px] font-bold transition-all border ${formData[field].includes(val) ? 'btn-active border-blue-600' : 'bg-gray-50 text-gray-400 border-transparent hover:bg-gray-100'}`}>
                                {val}
                            </button>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white/80 backdrop-blur-md border-b sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-2 font-black italic text-xl tracking-tighter text-blue-600">
                                <i className="fa-solid fa-bolt-lightning"></i> NIMO MUSIC
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowHelp(true)} className="px-4 py-2 rounded-full bg-blue-50 text-blue-600 text-[11px] font-black hover:bg-blue-100 transition-all flex items-center gap-2">
                                    <i className="fa-solid fa-circle-question"></i> HELP
                                </button>
                                <button onClick={() => setShowSettings(true)} className="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-[11px] font-black flex items-center gap-2">
                                    <i className="fa-solid fa-key"></i> API SETTINGS
                                </button>
                                <button onClick={() => setLanguage(l => l === 'ko' ? 'en' : 'ko')} className="w-10 h-10 rounded-full bg-black text-white text-[10px] font-black uppercase">{language}</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-6 py-10">
                        {!result ? (
                            <div className="bg-white rounded-[2.5rem] shadow-xl border p-8 md:p-12 animate-fade">
                                <RenderOptions label="장르 / GENRE" field="genre" list={options.genres[language]} />
                                <RenderOptions label="무드 / MOOD" field="mood" list={options.moods[language]} />
                                <RenderOptions label="보컬 / VOCAL" field="vocal" list={options.vocals[language]} />
                                <RenderOptions label="악기 / INSTRUMENTS" field="instruments" list={options.instruments[language]} />
                                <RenderOptions label="믹싱 / MIXING" field="mixing" list={options.mixingStyles[language]} />

                                <div className="grid md:grid-cols-2 gap-8 mb-8">
                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 italic">시대 / ERA</label>
                                        <select className="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm" 
                                            value={formData.era} onChange={e => setFormData({...formData, era: e.target.value})}>
                                            <option value="">Select Era</option>
                                            {options.eras[language].map(e => <option key={e} value={e}>{e}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 italic">가사 언어 / LYRICS LANG</label>
                                        <div className="flex gap-2">
                                            {['ko', 'en'].map(l => (
                                                <button key={l} onClick={() => setFormData({...formData, lyricsLanguage: l})}
                                                    className={`flex-1 py-4 rounded-2xl font-black text-xs transition-all border ${formData.lyricsLanguage === l ? 'btn-active border-blue-600' : 'bg-gray-50 text-gray-400 border-gray-100'}`}>
                                                    {l === 'ko' ? 'KOREAN' : 'ENGLISH'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="mb-10">
                                    <label className="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 italic">테마 및 스토리 / THEME & STORY</label>
                                    <textarea className="w-full p-6 bg-gray-50 border border-gray-100 rounded-[2rem] outline-none focus:ring-2 focus:ring-blue-500 h-32 font-medium" 
                                        placeholder="어떤 이야기를 노래에 담고 싶나요?" onChange={e => setFormData({...formData, theme: e.target.value})} />
                                </div>

                                <button onClick={generatePrompt} disabled={isGenerating} 
                                    className="w-full py-6 bg-black text-white rounded-[2rem] font-black text-xl hover:bg-blue-600 transition-all shadow-xl flex items-center justify-center gap-4 active:scale-95 disabled:opacity-50">
                                    {isGenerating ? <i className="fa-solid fa-circle-notch animate-spin"></i> : <i className="fa-solid fa-wand-magic-sparkles"></i>}
                                    {isGenerating ? 'AI 생성 중...' : '프롬프트 생성하기'}
                                </button>
                            </div>
                        ) : (
                            <div className="bg-white rounded-[3rem] shadow-2xl border p-8 md:p-12 animate-fade">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl font-black italic tracking-tighter text-blue-600">GENERATED PROMPT</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => {navigator.clipboard.writeText(result); alert('복사되었습니다!');}} 
                                            className="bg-blue-50 text-blue-600 px-6 py-3 rounded-2xl font-black text-sm hover:bg-blue-100">
                                            <i className="fa-solid fa-copy mr-2"></i> 복사
                                        </button>
                                        <button onClick={() => setResult(null)} className="bg-gray-100 text-gray-600 px-6 py-3 rounded-2xl font-black text-sm">닫기</button>
                                    </div>
                                </div>
                                <pre className="bg-gray-900 text-blue-100 p-8 md:p-12 rounded-[2.5rem] whitespace-pre-wrap font-mono text-sm leading-relaxed overflow-x-auto shadow-inner border-[12px] border-gray-800">
                                    {result}
                                </pre>
                            </div>
                        )}
                    </main>

                    {/* --- [도움말 팝업(HELP)] --- */}
                    {showHelp && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/70 backdrop-blur-md animate-in fade-in duration-300">
                            <div className="bg-white rounded-[3rem] w-full max-w-lg p-10 shadow-2xl relative overflow-y-auto max-h-[90vh]">
                                <button onClick={() => setShowHelp(false)} className="absolute top-8 right-8 text-gray-300 hover:text-black"><i className="fa-solid fa-xmark text-2xl"></i></button>
                                <h3 className="text-2xl font-black italic tracking-tighter mb-8 text-blue-600 border-b pb-4">NIMO MUSIC 사용 가이드</h3>
                                
                                <div className="space-y-8 text-sm">
                                    <section>
                                        <h4 className="font-black text-gray-900 mb-3 flex items-center gap-2">
                                            <span className="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-[10px]">1</span>
                                            Gemini API 키 발급 받기
                                        </h4>
                                        <p className="text-gray-500 leading-relaxed ml-8">
                                            구글 계정만 있다면 무료로 가능합니다. <br/>
                                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-500 underline font-bold">Google AI Studio (여기를 클릭)</a> 에 접속하여 <b>'Create API Key'</b>를 클릭하세요.
                                        </p>
                                    </section>

                                    <section>
                                        <h4 className="font-black text-gray-900 mb-3 flex items-center gap-2">
                                            <span className="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-[10px]">2</span>
                                            키 등록 및 저장
                                        </h4>
                                        <p className="text-gray-500 leading-relaxed ml-8">
                                            발급받은 키를 <b>API SETTINGS</b> 메뉴에 넣고 연결 테스트를 진행하세요. 키는 본인 브라우저에만 암호화되어 안전하게 저장됩니다.
                                        </p>
                                    </section>

                                    <section>
                                        <h4 className="font-black text-gray-900 mb-3 flex items-center gap-2">
                                            <span className="w-6 h-6 bg-black text-white rounded-full flex items-center justify-center text-[10px]">3</span>
                                            프롬프트 생성
                                        </h4>
                                        <p className="text-gray-500 leading-relaxed ml-8">
                                            원하는 음악 스타일을 선택 후 <b>프롬프트 생성하기</b>를 누르면 AI가 Suno AI용 전문 태그와 가사를 작성해 줍니다.
                                        </p>
                                    </section>
                                </div>
                                <button onClick={() => setShowHelp(false)} className="w-full mt-10 py-5 bg-black text-white rounded-2xl font-black hover:bg-blue-600 transition-all">확인했습니다</button>
                            </div>
                        </div>
                    )}

                    {/* --- [API 설정 팝업] --- */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300">
                            <div className="bg-white rounded-[3rem] w-full max-w-md p-10 shadow-2xl relative">
                                <button onClick={() => setShowSettings(false)} className="absolute top-8 right-8 text-gray-300 hover:text-black"><i className="fa-solid fa-xmark text-2xl"></i></button>
                                <h3 className="text-2xl font-black italic tracking-tighter uppercase mb-8">Gemini AI Config</h3>
                                <div className="space-y-6">
                                    <div className="p-4 bg-blue-50 rounded-2xl text-[11px] text-blue-800 font-bold border border-blue-100">
                                        <i className="fa-solid fa-shield-halved mr-2"></i>
                                        이 키는 본인 기기에만 암호화 저장됩니다.
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 block italic">API Key (Gemini 2.5 Flash)</label>
                                        <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="AIzaSy..." 
                                            className="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl py-4 px-6 focus:border-blue-500 outline-none font-mono text-sm" />
                                    </div>
                                    <button onClick={saveAndTestKey} disabled={testStatus === 'testing'} 
                                        className={`w-full py-5 rounded-2xl font-black transition-all flex items-center justify-center gap-3 text-white ${testStatus === 'success' ? 'bg-green-500' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                        {testStatus === 'testing' ? <i className="fa-solid fa-spinner animate-spin"></i> : 
                                         testStatus === 'success' ? <i className="fa-solid fa-check"></i> : <i className="fa-solid fa-plug"></i>}
                                        {testStatus === 'testing' ? '연결 확인 중...' : testStatus === 'success' ? '연결 성공!' : '저장 및 연결 테스트'}
                                    </button>
                                    {testStatus === 'fail' && <p className="text-center text-red-500 text-[11px] font-bold">연결 실패! 키와 프로젝트 설정을 확인하세요.</p>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- [로그인 앱] ---
        const App = () => {
            const [isAuth, setIsAuth] = useState(false);
            const [pw, setPw] = useState('');
            if (!isAuth) {
                return (
                    <div className="min-h-screen bg-black flex flex-col items-center justify-center text-white p-6">
                        <div className="max-w-md w-full space-y-10 text-center">
                            <h1 className="text-6xl font-black italic tracking-tighter">NIMO MUSIC</h1>
                            <input type="password" value={pw} onChange={e => setPw(e.target.value)} placeholder="PASSWORD" 
                                className="w-full bg-white/10 border border-white/20 rounded-2xl py-6 text-center font-bold tracking-[1em] outline-none focus:border-blue-500" />
                            <button onClick={() => pw === 'nimo123' && setIsAuth(true)} className="w-full bg-white text-black py-6 rounded-2xl font-black text-lg hover:bg-blue-500 hover:text-white transition-all">ENTER SYSTEM</button>
                        </div>
                    </div>
                );
            }
            return <SunoPromptGenerator />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
